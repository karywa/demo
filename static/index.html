<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Agent Schedule</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 16px;
      }
      .controls {
        margin-bottom: 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        gap: 4px;
      }
      .cell {
        border: 1px solid #ddd;
        padding: 6px;
        text-align: center;
        font-size: 12px;
        cursor: pointer;
      }
      .cell-header {
        font-weight: bold;
        background: #f5f5f5;
      }
      .tooltip {
        position: fixed;
        pointer-events: none;
        background: #333;
        color: white;
        padding: 6px 8px;
        border-radius: 4px;
        font-size: 11px;
        opacity: 0;
        transition: opacity 0.1s;
        z-index: 999;
      }
    </style>
  </head>
  <body>
    <h1>Agent Schedule (PT)</h1>

    <div class="controls">
      <label>
        CSV File:
        <input id="csvFile" type="file" accept=".csv" />
      </label>

      <label style="margin-left: 8px;">
        Utilization:
        <input
          id="utilization"
          type="number"
          value="1.0"
          min="0.1"
          max="1"
          step="0.05"
        />
      </label>

      <button id="loadBtn">Load</button>
    </div>

    <div id="grid" class="grid"></div>
    <div id="tooltip" class="tooltip"></div>

    <script>
      const gridEl = document.getElementById("grid");
      const tooltipEl = document.getElementById("tooltip");

      document
        .getElementById("loadBtn")
        .addEventListener("click", () => loadSchedule());

      async function loadSchedule() {
        const fileInput = document.getElementById("csvFile");
        const utilization = document.getElementById("utilization").value;

        if (fileInput.files.length === 0) {
          gridEl.innerHTML =
            '<div style="color:red;">Please choose a CSV file.</div>';
          return;
        }

        const formData = new FormData();
        // IMPORTANT: the field name here must be "file"
        formData.append("file", fileInput.files[0]);
        formData.append("utilization", utilization);

        gridEl.innerHTML = "Loading...";

        try {
          const resp = await fetch("/api/schedule", {
            method: "POST",
            body: formData,
            // DO NOT manually set Content-Type here; the browser will set proper multipart boundary
          });

          if (!resp.ok) {
            let errText = `HTTP ${resp.status}`;
            try {
              const errJson = await resp.json();
              if (errJson.error) errText = errJson.error;
            } catch (_) {}
            throw new Error(errText);
          }

          const data = await resp.json();
          renderGrid(data);
        } catch (e) {
          gridEl.innerHTML = `<div style="color:red;">Error: ${e.message}</div>`;
        }
      }

      function renderGrid(schedule) {
        gridEl.innerHTML = "";

        // header row: hours
        for (const entry of schedule) {
          const header = document.createElement("div");
          header.className = "cell cell-header";
          header.textContent = entry.hour;
          gridEl.appendChild(header);
        }

        // second row: totals (with tooltip)
        for (const entry of schedule) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.textContent = entry.total;

          const customers = entry.customers || {};
          const breakdownLines =
            Object.keys(customers).length > 0
              ? Object.entries(customers)
                  .map(([name, agents]) => `${name}: ${agents}`)
                  .join("\n")
              : "none";

          cell.addEventListener("mousemove", (ev) => {
            tooltipEl.textContent = `${entry.hour}\nTotal: ${
              entry.total
            }\n\n${breakdownLines}`;
            tooltipEl.style.left = ev.pageX + 10 + "px";
            tooltipEl.style.top = ev.pageY + 10 + "px";
            tooltipEl.style.opacity = "1";
          });

          cell.addEventListener("mouseleave", () => {
            tooltipEl.style.opacity = "0";
          });

          gridEl.appendChild(cell);
        }
      }
    </script>
  </body>
</html>
